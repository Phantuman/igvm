#!/usr/bin/python
from __future__ import print_function

import argparse
from fabric.network import disconnect_all

import sys
import os

sys.path = ['.'] + sys.path
#print('Disabled during the weekend')
#sys.exit(1)

import adminapi

from managevm.buildvm import buildvm

parser = argparse.ArgumentParser(description='Creates a new virtual machine.')
parser.add_argument('guest',        metavar='guest',           help='Hostname of the guest system')
parser.add_argument('--localimage', metavar='localimage',      help='Image file for for installation from local fs')
parser.add_argument('--postboot',   metavar='postboot_script', help='Run postboot_script on the guest after first boot')
parser.add_argument('--nopuppet',   action='store_true',       help='Skip running puppet in chroot before powering up',)

args = vars(parser.parse_args())

adminapi.auth()

buildvm(args.pop('guest'), **args)

# Force disconnection from Fabric.
# Otherwise errors in Paramiko are trigerred.
disconnect_all
