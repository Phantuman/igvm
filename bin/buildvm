#!/usr/bin/python
from __future__ import print_function
import sys

import argparse
from fabric.network import disconnect_all

import adminapi

from igvm.buildvm import buildvm
from igvm.utils import ManageVMError

print('This is deprecated use "igvm create"')

parser = argparse.ArgumentParser(description='Creates a new virtual machine.')
parser.add_argument('guest',        metavar='guest',           help='Hostname of the guest system')
parser.add_argument('--localimage', metavar='localimage',      help='Image file for for installation from local fs')
parser.add_argument('--postboot',   metavar='postboot_script', help='Run postboot_script on the guest after first boot')
parser.add_argument('--nopuppet',   action='store_true',       help='Skip running puppet in chroot before powering up',)

args = vars(parser.parse_args())

adminapi.auth()

try:
    buildvm(args.pop('guest'), **args)
except ManageVMError as error:
    print(error)
    sys.exit(1)

# Force disconnection from Fabric.
# Otherwise errors in Paramiko are trigerred.
disconnect_all()
