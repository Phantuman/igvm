#!/usr/bin/python

import argparse
from fabric.network import disconnect_all

sys.path = ['.'] + sys.path

import adminapi

from managevm.migratevm import migratevm

parser = argparse.ArgumentParser(description='Migrate a virtual machine.')
parser.add_argument('--newip',        metavar='IP address',     help='IP address to move VM to, in case you migrate between segments')
parser.add_argument('--nopuppet',     action='store_true',      help='Skip running puppet in chroot before powering up')
parser.add_argument('--nolbdowntime', action='store_true',      help='Don\t use testtool\'s downtime feature during migration')
parser.add_argument('--offline',      action='store_true',      help='Force offline migration')
parser.add_argument('vm_hostname',    metavar='vm_hostname',    help='Hostname of the guest system')
parser.add_argument('dsthv_hostname', metavar='dsthv_hostname', help='Hostname of destination hypervisor')

args = vars(parser.parse_args())

adminapi.auth()

migratevm(args.pop('vm_hostname'), args.pop('dsthv_hostname'), **args)

# Force disconnection from Fabric.
# Otherwise errors in Paramiko are trigerred.
disconnect_all
